@using AccessManagementLaredo_App.Models;
@using Microsoft.AspNetCore.Identity;
@inject UserManager<ApplicationUser> userManager;

@{
    var currentUser = await userManager.GetUserAsync(User);
    var roles = userManager.GetRolesAsync(currentUser).Result;
    string currentUserRole = roles[0];
    string currentUserType = "";
    if (currentUserRole == "TRAFFIC" || currentUserRole == "TPD" || currentUserRole == "AREAOFFICE" || currentUserRole == "SUPERADMIN")
        currentUserType = "INTERNAL";
    else
        currentUserType = "EXTERNAL";
}

@* Page header *******************************************************************************************************************************@
<br />
<h1>
    Permit Requests Dashboard
</h1>
<br />

@* Button to create a new request ***************************************************************************************************************@
@{
    if (currentUserType == "EXTERNAL")
    {
                    <form method="get" asp-action="Index" asp-controller="NewRequest">
                        <kendo-button type="submit" id="newRequestButton" theme-color="ThemeColor.Primary" size="ComponentSize.Large">&nbsp;&nbsp;&nbsp; New Request &nbsp;&nbsp;&nbsp;</kendo-button>
                    </form>
                    <br />
    }
}

@* Block for Grid *******************************************************************************************************************************@
<kendo-grid name="permitRequestsGrid" on-data-bound="onWorkOrderDataBound" height="720">
    <datasource type="DataSourceTagHelperType.Ajax" page-size="20" server-operation="true" >
        <transport>
            <read url="/PermitRequest/Read" />
            <destroy url="/PermitRequest/Delete" />
        </transport>
        <schema>
            <model id="Id">
                <fields>
                    <field name="Id" type="number" editable="false"></field>
                    <field name="UserId" type="String" editable="false"></field>
                    <field name="PermitRequestNumber" type="String"></field>
                    <field name="RequestType" type="String" editable="false"></field>
                    <field name="RequestorFullName" type="String" editable="false"></field>
                    <field name="DateCreated" type="Date" editable="false"></field>
                    <field name="DateUpdated" type="Date" editable="false"></field>
                    <field name="StatusAreaOfficeCode" type="String" editable="false"></field>
                    <field name="StatusTrafficCode" type="String" editable="false"></field>
                    <field name="StatusTPDCode" type="String" editable="false"></field>
                    <field name="StatusExternalCode" type="String" editable="false"></field>

                    <field name="StatusAreaOfficeName" type="String" editable="false"></field>
                    <field name="StatusTrafficName" type="String" editable="false"></field>
                    <field name="StatusTPDName" type="String" editable="false"></field>
                    <field name="StatusExternalName" type="String" editable="false"></field>
                </fields>
            </model>
        </schema>
    </datasource>
    @* <editable mode="popup" template-id="popup-editor" /> *@
    <groupable enabled="true" />
    <sortable enabled="true" />
    <filterable enabled="true" />
    <pageable button-count="5" refresh="true" page-sizes="new int[] { 5, 10, 20 }">
    </pageable>
    <columns>
        <column field="Id" title="Id" hidden=true />
        @* <column field="Number" template="#=template(data)#" title="Request Id" width="150" /> *@
        <column field="PermitRequestNumber" title="Request #" width="120" />
        <column field="UserId" title="User Id" hidden=true />
        <column field="RequestType" title="Request" width="120" />
        <column field="RequestorFullName" title="Requestor Name" width="220" />
        <column field="DateCreated" title="Created on" format="{0:yyyy/MM/dd}" hidden=true width="170" />
        <column field="DateUpdated" title="Last Updated" format="{0:yyyy/MM/dd}" width="140" />
        @{
            if (currentUserType == "INTERNAL")
            {
                <column field="StatusAreaOfficeName" title="Status Area Office" />
                <column field="StatusTrafficName" title="Status Traffic" />
                <column field="StatusTPDName" title="Status TPD" />
            }
            else
            {
                <column field="StatusExternalName" title="Status" />
            }
        }
        <column width="135">
            <commands>
                <column-command text="Edit" click="editRecord"></column-command>
                <column-command text="Log" click="viewEventLog"></column-command>
            </commands>
        </column>
    </columns>
</kendo-grid>

@* Partial view for events log ********************************************************************************************************* *@
<partial name="_EventsLog" />

@* ************************************************************************************************************************************************************ *@
@*                                                                      Javascript code                                                                         *@
@* ************************************************************************************************************************************************************ *@
<script>
    function editRecord(e) {
        // Prevent the default edit behavior
        e.preventDefault();

        // Get the dataItem associated with the clicked button
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        // Get the ID of the selected record
        var id = dataItem.Id;
        var reqType = dataItem.RequestType;

        // Redirect to the new view with the record ID
        if ("@currentUserType" == "INTERNAL") {
            window.location.href = '@Url.Action("PermitRequestReview", "NewRequest")' + '?id=' + id + '&type=' + reqType;
        } else { 
            window.location.href = '@Url.Action("Index", "NewRequest")' + '?id=' + id + '&type=' + reqType;
        }
    }


    // Function to handle the Grid button click
    function viewEventLog(e) {
        // Get the grid instance
        var grid = $("#permitRequestsGrid").data("kendoGrid");

        // Get the clicked row's data item
        var dataItem = grid.dataItem($(e.currentTarget).closest("tr"));

        // Extract the ID or other necessary information from the row
        var id = dataItem.Id; 

        // Call the reusable function
        openEventsWindow('@currentUserRole', id);
    }

    function onWorkOrderDataBound(e) {
        var grid = this;
        grid.table.find("tr").each(function () {
            var dataItem = grid.dataItem(this);

            // Apply status styling to columns 7, 8, and 9
            [7, 8, 9].forEach(function (colIndex) {
                var cell = this.cells.item(colIndex);
                if (!cell) return;

                var statusText = cell.innerText.trim();
                var cssClass = "";

                switch (statusText) {
                    case "DRAFT":
                        cssClass = "status-css-draft";
                        break;
                    case "UNDER REVIEW":
                        cssClass = "status-css-under-review";
                        break;
                    case "AWAITING ACTION":
                        cssClass = "status-css-awaiting";
                        break;
                    case "RETURNED TO USER":
                        cssClass = "status-css-returned";
                        break;
                    case "APPROVED":
                    case "REVIEWED":
                    case "N/A":
                        cssClass = "status-css-approved";
                        break;
                    case "COMPLETE":
                        cssClass = "status-css-complete";
                        break;
                }

                if (cssClass) {
                    cell.innerHTML = `<span class="${cssClass}">${statusText}</span>`;
                }
            }, this); // bind `this` to the row context

            // Disable edit button logic
            var status7 = this.cells.item(7)?.innerText.trim();
            if ("@currentUserType" == "EXTERNAL") {
                if (status7 === "UNDER REVIEW" || status7 === "APPROVED") {
                    this.cells.item(8).getElementsByClassName("k-grid-Edit")[0].setAttribute("disabled", true);
                }
            } else {
                if (status7 === "RETURNED TO USER") {
                    this.cells.item(10).getElementsByClassName("k-grid-Edit")[0].setAttribute("disabled", true);
                }
            }

            kendo.bind($(this), dataItem);
        });
    }
</script>

<script id="events-template" type="text/x-kendo-template">

</script>